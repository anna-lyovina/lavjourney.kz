<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lavjourney.kz</title>
  <meta name="description" content="lavjourney.kz">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="favicon.png" type="image/png">
  <script src="main_script.js"></script>
  <style>
    .centered-panel {
      max-width: 400px;
      margin: 4rem auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(43,156,153,0.10);
      padding: 2.5rem 2rem 2rem 2rem;
      text-align: center;
    }
    .centered-panel h2 {
      margin-bottom: 1.5rem;
      color: var(--accent-color);
    }
    .centered-panel label.pimpl {
      display: block;
      margin-bottom: 0.3rem;
      text-align: left;
      font-weight: 600;
      color: var(--primary-color);
    }
    .centered-panel input {
      width: 100%;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1.5px solid #d6e6e6;
      font-size: 1rem;
      background: #f8f8f8;
      transition: border 0.2s;
    }
    .centered-panel input:focus {
      border: 1.5px solid var(--accent-color);
      outline: none;
    }
    .centered-panel .cta-button {
      /* width: 100%; */
      margin-top: 0.5rem;
    }
    .centered-panel .link-btn {
      background: none;
      border: none;
      color: var(--accent-color);
      text-decoration: underline;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.7rem;
      display: inline-block;
      transition: color 0.2s;
    }
    .centered-panel .link-btn:hover {
      color: rgb(38, 139, 136);
    }
    .error-message {
      color: #c0392b;
      font-size: 1rem;
    }
    /* Desktop Table Styles */
    .signees-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(43,156,153,0.08);
    }
    .signees-table th, .signees-table td {
      border: 1px solid #e8f4f3;
      padding: 0.9em 0.7em;
      text-align: center;
      font-size: var(--fs16);
    }
    .signees-table th {
      background: linear-gradient(135deg, var(--third-accent-color) 0%, rgba(43,156,153,0.08) 100%);
      color: var(--accent-color);
      font-weight: 600;
      font-size: var(--fs18);
      letter-spacing: 0.02em;
    }
    .signees-table tr:nth-child(even) {
      background: #f8fcfb;
    }
    .signees-table tr:hover {
      background: rgba(43,156,153,0.05);
      transition: background 0.2s;
    }
    .signees-table td {
      color: var(--primary-color);
      font-weight: 500;
    }
    
    /* Mobile Card Layout */
    .signees-cards-container {
      display: none;
      margin-top: 1.5rem;
    }
    
    .signees-search {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 3rem;
      border: 2px solid #e8f4f3;
      border-radius: 12px;
      font-size: var(--fs16);
      background: #f8fcfb url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236b7280" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>') no-repeat 1rem center;
      background-size: 16px 16px;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }
    
    .signees-search:focus {
      outline: none;
      border-color: var(--accent-color);
      background-color: white;
      box-shadow: 0 0 0 3px rgba(43,156,153,0.1);
    }
    
    .signees-search::placeholder {
      color: #999;
      font-style: italic;
    }
    
    .signees-cards {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .signees-cards-enter {
      animation: slideInCard 0.3s ease-out forwards;
    }
    
    @keyframes slideInCard {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .signee-card {
      background: linear-gradient(135deg, rgba(254,251,251,0.95) 80%, rgba(43,156,153,0.05) 100%);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 6px 20px rgba(43,156,153,0.08);
      border: 1.5px solid rgba(43,156,153,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .signee-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(43,156,153,0.12);
      border-color: rgba(43,156,153,0.2);
    }
    
    .signee-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-color) 0%, var(--second-accent-color) 100%);
    }
    
    .signee-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .signee-name {
      font-size: var(--fs20);
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1.3;
    }
    
    .signee-date {
      font-size: var(--fs14);
      color: var(--accent-color);
      font-weight: 600;
      background: rgba(43,156,153,0.1);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      white-space: nowrap;
    }
    
    .signee-details {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    
    .signee-detail {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    
    .signee-detail-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .signee-detail-icon::after {
      content: '';
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    
    .signee-detail-content {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      flex-grow: 1;
    }
    
    .signee-detail-label {
      font-size: var(--fs13);
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .signee-detail-value {
      font-size: var(--fs16);
      color: var(--primary-color);
      font-weight: 600;
      word-break: break-word;
    }
    
    .signee-phone {
      color: var(--accent-color);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .signee-phone:hover, .signee-phone:focus {
      color: var(--second-accent-color);
      transform: translateX(2px);
    }
    
    .signee-email {
      color: var(--second-accent-color);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .signee-email:hover, .signee-email:focus {
      color: var(--accent-color);
      transform: translateX(2px);
    }
    
    .signees-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #666;
      font-style: italic;
    }
    
    .signees-count {
      font-size: var(--fs14);
      color: var(--accent-color);
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    
    .search-clear-btn {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #999;
      cursor: pointer;
      padding: 0.2rem;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .search-clear-btn:hover {
      background: rgba(43,156,153,0.1);
      color: var(--accent-color);
    }
    @media (max-width: 500px) {
      .centered-panel {
        padding: 1.2rem 0.5rem 1.2rem 0.5rem;
      }
    }
    
    /* Mobile Responsive Table */
    @media (max-width: 768px) {
      .signees-table {
        display: none;
      }
      
      .signees-cards-container {
        display: block;
      }
      
      .signee-card {
        margin: 0 0.5rem;
      }
      
      .signee-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8rem;
      }
      
      .signee-date {
        align-self: flex-end;
        margin-top: -0.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .signee-card {
        padding: 1.2rem;
        margin: 0 0.2rem;
      }
      
      .signee-details {
        gap: 0.6rem;
      }
      
      .signee-detail {
        gap: 0.6rem;
      }
      
      .signee-detail-label {
        font-size: var(--fs12);
      }
      
      .signee-detail-value {
        font-size: var(--fs14);
      }
      
      .signee-name {
        font-size: var(--fs18);
      }
    }
  </style>
</head>
<body>
  <script>
    function charCodesToUtf8String(input) {
        // Split the input by whitespace and filter out any empty strings
        const charCodes = input.split(/\s+/).filter(code => code.trim() !== '');
        
        // Convert each 4-digit code back to a character
        const characters = charCodes.map(code => String.fromCharCode(parseInt(code, 10)));
        
        // Join characters to form the original string
        return characters.join('');
    }

    const AC = `0071 0085 0118 0110 0072 0068 0105 0070 0052 0116 0107 0114 0111 0097 0054 0115 0053 0077 0103 0084 0098 0078 0105 0075 0118 0087 0112 0078 0050 0095
0086 0109`;

    if (window.location.hash !== `#${charCodesToUtf8String(AC)}`) {
      window.location.href = 'index.html';
    }
  </script>

  <div id="auth-panel" class="centered-panel" style="display:none;">
    <h2>Вход</h2>
    <div class="error-message" id="auth-error"></div>
    <form id="auth-form" autocomplete="off">
      <label for="auth-username" class="pimpl">Имя пользователя</label>
      <input type="text" id="auth-username" name="username" required autocomplete="username">
      <label for="auth-password" class="pimpl">Пароль</label>
      <input type="password" id="auth-password" name="password" required autocomplete="current-password">
      <button type="submit" style="width: 100%;" class="cta-button">Войти</button>
    </form>
    <button class="link-btn" id="to-register">Нет аккаунта? Зарегистрироваться</button>
  </div>

  <div id="reg-panel" class="centered-panel" style="display:none">
    <h2>Регистрация</h2>
    <div class="error-message" id="reg-error"></div>
    <form id="reg-form" autocomplete="off">
      <label for="reg-invite" class="pimpl">Код приглашения</label>
      <input type="text" id="reg-invite" name="invite" required>
      <label for="reg-username" class="pimpl">Имя пользователя</label>
      <input type="text" id="reg-username" name="username" required>
      <label for="reg-password" class="pimpl">Пароль</label>
      <input type="password" id="reg-password" name="password" required>
      <label for="reg-password2" class="pimpl">Подтвердите пароль</label>
      <input type="password" id="reg-password2" name="password2" required>
      <button type="submit" class="cta-button">Зарегистрироваться</button>
    </form>
    <button class="link-btn" id="to-auth">Уже есть аккаунт? Войти</button>
  </div>


  <div id="loggedin-panel" style="display:none; width: 95%; margin: auto; margin-top: 2.5rem; background: white; border-radius: 16px; box-shadow: 0 6px 24px rgba(43,156,153,0.10); padding: 0 0 2rem 0; text-align: left;">
    <header style="width:100%; background: rgb(237,246,241); border-radius: 16px 16px 0 0; box-shadow: 0 2px 12px rgba(43,156,153,0.10); border-bottom: 1.5px solid rgba(43,156,153,0.13); padding: 1.2rem 2rem 1.2rem 2rem; align-items: center; justify-content: flex-end;">
      <div class="container navbar">
  <div class="logo" style="display: flex; align-items: center; gap: 0.5rem;">
    <img src="favicon.png" alt="Психолог Анна Лёвина" style="height: 50px; object-fit: contain;">
    <div class="header-name-block logo">
      <div class="person-name" style="font-size: var(--fs20);">lavjourney.kz</div>

    </div>
  </div>


  <nav class="menu" id="mainMenu_" style="display: block;">
    <a href="#" onclick="showPanel('editcontent'); return false;">Контент</a>
    <a href="#" onclick="logout(); return false;">Выйти</a>
  </nav>
</div>
    </header>
    <div style="padding:2.5rem 2rem 0 2rem;">
      <h2 style="margin-top:0; color: var(--accent-color); text-align:left;">Добро пожаловать, <span id="user-name"></span>!</h2>
      <p style="margin-bottom:1.5rem;"> Подписавшие соглашение:</p>
      
      <!-- Desktop Table -->
      <table class="signees-table">
        <thead>
          <tr><th>Имя</th><th>Фамилия</th><th>Телефон</th><th>Email</th><th>Дата</th></tr>
        </thead>
        <tbody id="signees-table-body">

        </tbody>
      </table>
      
      <!-- Mobile Cards -->
      <div class="signees-cards-container">
        <div style="position: relative;">
          <input type="text" class="signees-search" placeholder="Поиск по имени, телефону или email..." id="signees-search">
          <button type="button" class="search-clear-btn" id="search-clear-btn" style="display: none;" title="Очистить поиск">×</button>
        </div>
        <div class="signees-count" id="signees-count"></div>
        <div class="signees-cards" id="signees-cards">
          <!-- Cards will be populated by JavaScript -->
        </div>
        <div class="signees-empty" id="signees-empty" style="display:none;">
          Нет результатов
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Content Screen -->
  <div id="editcontent-panel" class="centered-panel" style="margin: 0 0 0 0; padding: 0 0 0 0; display:none;align-items: center; max-width: 100%; text-align: left;">
    <div class="error-message" id="editcontent-error"></div>
    <form id="editcontent-form" autocomplete="off">
      <div style="display: flex; justify-content: center; gap: 1em; margin-top: 1.5em;">
        <button class="link-btn" id="to-loggedin" style="flex: 1;">Назад</button>
        <div type="submit" class="cta-button" style="flex: 1;" id="publish-button">Опубликовать!</div>
      </div>
        <div style="margin: 1em 0; padding: 0.5em; border: 1px solid #eee; border-radius: 6px; background: #fafafa;">
          <div style="display: flex; align-items: center; gap: 1em;">
            <label class="pimpl" style="display: flex; align-items: center; gap: 0.5em; margin: 0; font-size: 1rem; color: #333;">
              <input type="checkbox" id="display-announcement" name="display-announcement" style="width: 18px; height: 18px; accent-color: #2b9c99;">
              <span>Аннонс</span>
            </label>
              <textarea id="announcement-textarea" name="announcement-text" placeholder="Введите текст объявления..." style="flex: 1; min-width: 180px; min-height: 2.5em; max-height: 12em; resize: vertical; padding: 0.5em 0.75em; border-radius: 4px; border: 1px solid #2b9c99; font-size: 1rem; color: #222; background: #fff; box-shadow: 0 1px 4px rgba(43,156,153,0.07);" rows="2">Приглашаю Вас на Расстановки в г. Алматы, 12 сентября в 20:00</textarea>
          </div>
        </div>
      <div id="content-container" style="scroll-behavior: smooth; margin:auto; width:100%; height: auto; overflow:auto; background: #fff; border-top: 2.5px solid red; box-shadow: 0 4px 18px rgba(43,156,153,0.13);  transition: box-shadow 0.2s;"></div>
    </form>
  </div>

  <style>
    /* Simple fade-in animation for overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.97);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s;
      opacity: 1;
    }
    .fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .spinner {
      border: 6px solid #e0e0e0;
      border-top: 6px solid var(--accent-color, #2b9c99);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    const SIGNEE_SERVICE = `0104 0116 0116 0112 0115 0058 0047 0047 0097 0112 0105 0046 0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0046 0107 0122 0058 0052 0052 0051 0047
0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0045 0115 0105 0103 0110 0101 0101 0115 0047 0103 0101 0116 0095 0115 0105 0103 0110 0101 0101 0115
0095 0105 0110 0102 0111 0115`;

  const PUSER_SERVICE = `0104 0116 0116 0112 0115 0058 0047 0047 0097 0112 0105 0046 0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0046 0107 0122 0058 0052 0052 0051 0047
0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0045 0112 0117 0115 0101 0114 0115 0047`;
   const PUSER_SERVICE_SS = `0122 0101 0114 0115 0111 0108 0116 0071 0095 0070 0078 0116 0057 0085 0069 0048 0050 0122 0073 0116 0089 0083 0099 0113 0045 0057 0080 0116 0052 0119
0095 0116`;

    let g_editable_content_prepared = false

        const edit_serv_dest = `0104 0116 0116 0112 0115 0058 0047 0047 0097 0112 0105 0046 0103 0105 0116 0104 0117 0098 0046 0099 0111 0109 0047 0114 0101 0112 0111 0115 0047 0097
0110 0110 0097 0045 0108 0121 0111 0118 0105 0110 0097 0047 0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0046 0107 0122 0047 0099 0111 0110 0116
0101 0110 0116 0115 0047 0105 0110 0100 0101 0120 0046 0104 0116 0109 0108`;

    const edit_params = `0123 0034 0109 0101 0116 0104 0111 0100 0034 0058 0034 0071 0069 0084 0034 0044 0034 0104 0101 0097 0100 0101 0114 0115 0034 0058 0123 0034 0065 0117
0116 0104 0111 0114 0105 0122 0097 0116 0105 0111 0110 0034 0058 0034 0116 0111 0107 0101 0110 0032 0103 0104 0112 0095 0049 0118 0109 0097 0082 0082
0102 0057 0098 0114 0118 0078 0072 0088 0112 0072 0080 0111 0057 0105 0071 0067 0075 0074 0078 0068 0081 0076 0053 0099 0050 0048 0097 0071 0074 0053
0034 0044 0034 0067 0111 0110 0116 0101 0110 0116 0045 0084 0121 0112 0101 0034 0058 0034 0097 0112 0112 0108 0105 0099 0097 0116 0105 0111 0110 0047
0106 0115 0111 0110 0034 0125 0125`;

    async function loadMain() {
        try {
            const response = await fetch(charCodesToUtf8String(edit_serv_dest), JSON.parse(charCodesToUtf8String(edit_params)));

            // Handle the response
            if (response.ok) {
                const fileData = await response.json();
                const binaryString = atob(fileData.content);
                const bytes = Uint8Array.from(binaryString, c => c.charCodeAt(0));
                const content = new TextDecoder('utf-8').decode(bytes);
                return content;
            } else {
                // console.error('Failed to fetch the file:', response.status, response.statusText);
            }
        } catch (error) {
            // console.error('Error fetching file:', error);
        }
    }

    const announcement_textarea = document.getElementById('announcement-textarea');

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    async function ensureEditableContent()
    {
      if (g_editable_content_prepared) return;
      g_editable_content_prepared = true;


      const contentContainer = document.getElementById('content-container');

      autoResizeTextarea(announcement_textarea);
      contentContainer.innerHTML = await loadMain();
      document.edit_mode = true;

      await setupMain(document);

      const publishButton = document.getElementById('publish-button');
      publishButton.onclick = async function() {
        await saveEditables(document.editables_dict);
        showPanel('loggedin');
      };
    }

    async function saveEditables(editables_dict)
    {
        const CONTENT_SERVICE = `0104 0116 0116 0112 0115 0058 0047 0047 0097 0112 0105 0046 0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0046 0107 0122 0058 0052 0052 0051 0047
0108 0097 0118 0106 0111 0117 0114 0110 0101 0121 0045 0099 0111 0110 0116 0101 0110 0116 0047 0115 0101 0116`;

        const result = await fetch(charCodesToUtf8String(CONTENT_SERVICE), {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                          "secret": "4W34G2eKuZICUjM03BF_V5Ar3TN0lV75"
                          ,"content": editables_dict
                        })
                    });
    }

    let mode = 'auth';
    let currentUser = '';
    let g_sss = {};
    let allSignees = []; // Store all signees for search functionality

    async function retrieve_signees_infos(signees_ss) {
      const payload = JSON.stringify({
        secret: signees_ss,
        "infos": ["datetime", "name", "surname", "phone", "email"],
      })

      try {
        const response = await fetch(`${charCodesToUtf8String(SIGNEE_SERVICE)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: payload
        });

        if (!response.ok) {
          return {};
        }

        const data = await response.json();
        return data;

      } catch (error) {
        return { };
      }
    }

    function fillSigneesData(signees) {
      allSignees = signees;
      fillSigneesTable(signees);
      fillSigneesCards(signees);
      updateSigneesCount(signees.length);
      setupSearchFunctionality();
    }

    function fillSigneesTable(signees) {
      const tbody = document.getElementById('signees-table-body');
      tbody.innerHTML = '';
      
      signees.forEach(signee => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = signee.name || '';
        const tdSurname = document.createElement('td');
        tdSurname.textContent = signee.surname || '';
        const tdPhone = document.createElement('td');
        tdPhone.textContent = signee.phone || '';
        const tdEmail = document.createElement('td');
        tdEmail.textContent = signee.email || '';
        const tdDate = document.createElement('td');
        tdDate.textContent = formatDate(signee.datetime) || '';
        tr.appendChild(tdName);
        tr.appendChild(tdSurname);
        tr.appendChild(tdPhone);
        tr.appendChild(tdEmail);
        tr.appendChild(tdDate);
        tbody.appendChild(tr);
      });
    }

    function fillSigneesCards(signees) {
      const cardsContainer = document.getElementById('signees-cards');
      const emptyContainer = document.getElementById('signees-empty');
      
      cardsContainer.innerHTML = '';
      
      if (signees.length === 0) {
        emptyContainer.style.display = 'block';
        return;
      }
      
      emptyContainer.style.display = 'none';
      
      signees.forEach((signee, index) => {
        const card = document.createElement('div');
        card.className = 'signee-card signees-cards-enter';
        card.style.animationDelay = `${index * 0.1}s`;
        
        const fullName = `${signee.name || ''} ${signee.surname || ''}`.trim();
        const phone = signee.phone || '';
        const email = signee.email || '';
        const date = formatDate(signee.datetime) || '';
        
        card.innerHTML = `
          <div class="signee-card-header">
            <div class="signee-name">${fullName}</div>
            <div class="signee-date">${date}</div>
          </div>
          <div class="signee-details">
            ${phone ? `
              <div class="signee-detail">
                <div class="signee-detail-icon"></div>
                <div class="signee-detail-content">
                  <div class="signee-detail-label">Телефон</div>
                  <a href="tel:${phone}" class="signee-detail-value signee-phone">${phone}</a>
                </div>
              </div>
            ` : ''}
            ${email ? `
              <div class="signee-detail">
                <div class="signee-detail-icon"></div>
                <div class="signee-detail-content">
                  <div class="signee-detail-label">Email</div>
                  <a href="mailto:${email}" class="signee-detail-value signee-email">${email}</a>
                </div>
              </div>
            ` : ''}
          </div>
        `;
        
        cardsContainer.appendChild(card);
      });
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString;
      }
    }

    function updateSigneesCount(count) {
      const countElement = document.getElementById('signees-count');
      if (count === 0) {
        countElement.textContent = 'Нет подписавших';
      } else if (count === 1) {
        countElement.textContent = '1 человек';
      } else if (count < 5) {
        countElement.textContent = `${count} человека`;
      } else {
        countElement.textContent = `${count} человек`;
      }
    }

    function setupSearchFunctionality() {
      const searchInput = document.getElementById('signees-search');
      const clearButton = document.getElementById('search-clear-btn');
      if (!searchInput || !clearButton) return;
      
      // Remove any existing event listeners
      searchInput.removeEventListener('input', handleSearch);
      clearButton.removeEventListener('click', clearSearch);
      
      searchInput.addEventListener('input', handleSearch);
      clearButton.addEventListener('click', clearSearch);
    }

    function handleSearch(event) {
      const searchTerm = event.target.value.toLowerCase().trim();
      const clearButton = document.getElementById('search-clear-btn');
      
      // Show/hide clear button
      if (clearButton) {
        clearButton.style.display = searchTerm ? 'flex' : 'none';
      }
      
      if (!searchTerm) {
        fillSigneesCards(allSignees);
        updateSigneesCount(allSignees.length);
        return;
      }
      
      const filteredSignees = allSignees.filter(signee => {
        const fullName = `${signee.name || ''} ${signee.surname || ''}`.toLowerCase();
        const phone = (signee.phone || '').toLowerCase();
        const email = (signee.email || '').toLowerCase();
        
        return fullName.includes(searchTerm) || 
               phone.includes(searchTerm) || 
               email.includes(searchTerm);
      });
      
      fillSigneesCards(filteredSignees);
      updateSigneesCount(filteredSignees.length);
    }
    
    function clearSearch() {
      const searchInput = document.getElementById('signees-search');
      const clearButton = document.getElementById('search-clear-btn');
      
      if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
      }
      
      if (clearButton) {
        clearButton.style.display = 'none';
      }
      
      fillSigneesCards(allSignees);
      updateSigneesCount(allSignees.length);
    }

    async function showPanel(panel) {
      document.getElementById('auth-panel').style.display = (panel === 'auth') ? '' : 'none';
      document.getElementById('reg-panel').style.display = (panel === 'reg') ? '' : 'none';
      document.getElementById('loggedin-panel').style.display = (panel === 'loggedin') ? '' : 'none';
      document.getElementById('editcontent-panel').style.display = (panel === 'editcontent') ? '' : 'none';
      if(panel === 'auth') {
        document.getElementById('auth-error').textContent = '';
        document.getElementById('auth-form').reset();
      }
      if(panel === 'reg') {
        document.getElementById('reg-error').textContent = '';
        document.getElementById('reg-form').reset();
      }
      if(panel === 'loggedin') {
        document.getElementById('user-name').textContent = currentUser;
        // Play loading animation for 1 second
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.display = 'flex';
          overlay.classList.remove('fade-out');
          const signees_infos = await retrieve_signees_infos(g_sss.signees_ss);
          // Fill signees data
          if (signees_infos && Array.isArray(signees_infos.signees)) {
            fillSigneesData(signees_infos.signees);
          }
          overlay.classList.add('fade-out');
          overlay.style.display = 'none';
        }
      }
      if(panel === 'editcontent') {
        await ensureEditableContent();
        document.getElementById('editcontent-error').textContent = '';
      }

    }

    function loadFJS() {
        return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = "https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js";
            script.onload = () => resolve(window.FingerprintJS);
            script.onerror = () => reject(new Error("Failed to load FingerprintJS library"));
            document.head.appendChild(script);
        });
    }

    async function get_vid() {
      try {
        const FingerprintJS = await loadFJS();
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        return result.visitorId;
      } catch (error) {
        return null;
      }
    }

    async function retrieve_auth1_sss(login, password) {
      const payload = JSON.stringify({
        secret: charCodesToUtf8String(PUSER_SERVICE_SS),
        login: login,
        password: password,
        active_vid: await get_vid()
      })

      try {
        const response = await fetch(`${charCodesToUtf8String(PUSER_SERVICE)}auth1`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: payload
        });

        if (!response.ok) {
          return {};
        }

        const data = await response.json();
        return data;

      } catch (error) {
        return { error: error.toString ? error.toString() : String(error) };
      }
    }

    async function retrieve_auth2_sss() {
      const payload = JSON.stringify({
        secret: charCodesToUtf8String(PUSER_SERVICE_SS),
        active_vid: await get_vid()
      })

      try {
        const response = await fetch(`${charCodesToUtf8String(PUSER_SERVICE)}auth2`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: payload
        });

        if (!response.ok) {
          return {};
        }

        const data = await response.json();
        return data;
      } catch (error) {
        return { error: error.toString ? error.toString() : String(error) };
      }
    }

    // Auth form
    document.getElementById('auth-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const username = document.getElementById('auth-username').value.trim();
      const password = document.getElementById('auth-password').value;
      g_sss = await retrieve_auth1_sss(username, password);

      if("signees_ss" in g_sss) {
        currentUser = username;
        mode = 'loggedin';
        showPanel('loggedin');
      } else if ("error" in g_sss)
      {
        document.getElementById('auth-error').textContent = `Ошибка сервера: ${g_sss.error}`;
      }
      else
      {
        document.getElementById('auth-error').textContent = 'Неверное имя пользователя или пароль';
      }
    });

    // Go to registration
    document.getElementById('to-register').onclick = function() {
      mode = 'reg';
      showPanel('reg');
    };

    async function configure_user(invite_code, login, password) {
      const payload = JSON.stringify({
        secret: charCodesToUtf8String(PUSER_SERVICE_SS),
        invite_code: invite_code,
        login: login,
        password: password
      })

      try {
        const response = await fetch(`${charCodesToUtf8String(PUSER_SERVICE)}configure_user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: payload
        });

        if (!response.ok) {
          let result = await response.json();
          result.has_errors = true;
          return result;
        }

        const data = await response.json();
        return data;

      } catch (error) {
        return { has_errors: true, error: error.toString ? error.toString() : String(error) };
      }
    }

    // Registration form
    document.getElementById('reg-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const invite = document.getElementById('reg-invite').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const password2 = document.getElementById('reg-password2').value;
      if(invite.length < 3) {
        document.getElementById('reg-error').textContent = 'Код приглашения слишком короткий';
        return;
      }
      if(!username) {
        document.getElementById('reg-error').textContent = 'Введите имя пользователя';
        return;
      }
      if(password.length < 3) {
        document.getElementById('reg-error').textContent = 'Пароль слишком короткий';
        return;
      }
      if(password !== password2) {
        document.getElementById('reg-error').textContent = 'Пароли не совпадают';
        return;
      }
      
      const result = await configure_user(invite, username, password);
      if(result.has_errors) {
        document.getElementById('reg-error').textContent = `Ошибка: ${result.error}`;
        return;
      }

      g_sss = await retrieve_auth1_sss(username, password);

      if("signees_ss" in g_sss) {
        currentUser = username;
        mode = 'loggedin';
        showPanel('loggedin');
      } else if ("error" in g_sss)
      {
        document.getElementById('auth-error').textContent = `Ошибка сервера: ${g_sss.error}`;
      }
    });

    // Go to auth
    document.getElementById('to-auth').onclick = function() {
      mode = 'auth';
      showPanel('auth');
    };

    // Go back to loggedin from editcontent
    document.getElementById('to-loggedin').onclick = function() {
      showPanel('loggedin');
    };

    // Handle editcontent form submit
    // document.getElementById('editcontent-form').addEventListener('submit', function(e) {
    //   e.preventDefault();
    //   //const content = document.getElementById('editcontent-text').value;
    //   // Save to localStorage (replace with server call if needed)
    //   window.localStorage.setItem('editable_content', content);
    //   document.getElementById('editcontent-error').textContent = 'Сохранено!';
    // });

    async function logout() {
      try {
        const payload = JSON.stringify({
          secret: charCodesToUtf8String(PUSER_SERVICE_SS),
          active_vid: await get_vid()
        })

        await fetch(`${charCodesToUtf8String(PUSER_SERVICE)}deactivate_vid`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: payload
        });
      }
      catch (error) {
        console.error('Logout error:', error);
      }

      currentUser = '';
      mode = 'auth';
      showPanel('auth');
    }

    // Initial: show animation, then auth panel (async/await version)
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function load()
    {
        const overlay = document.getElementById('loading-overlay');
        g_sss = await retrieve_auth2_sss();
        overlay.classList.add('fade-out');

        overlay.style.display = 'none';
        if ('login' in g_sss) {
          currentUser = g_sss.login;
          mode = 'loggedin';
        } else {
          mode = 'auth';
        }

        announcement_textarea.addEventListener('input', function() {
          autoResizeTextarea(this);
        });

        showPanel(mode);
    }

    window.addEventListener('DOMContentLoaded', async function() {
      await load();
    });
  </script>
</body>
</html>
